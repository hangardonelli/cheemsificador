

let imgElement=document.getElementById("imageSrc"),inputElement=document.getElementById("fileInput"),maskElement=document.getElementById("canvasOutput"),texElement=new Image,bocaElement=new Image,bocamaskElement=new Image;function todolisto(){document.getElementById("ok").style.display="block"}function proceso(){texElement.src=cheemsTexSrc,bocaElement.src=cheemsBocaLSrc,bocamaskElement.src=cheemsBocamaskLSrc,bocaElement.src=cheemsBocaRSrc,bocamaskElement.src=cheemsBocamaskRSrc;let e=cv.imread(imgElement);new cv.Size(e.cols,e.rows);let t=new cv.Size(1e3,1e3);cv.resize(e,e,t);let n=new cv.Mat(e.rows,e.cols,e.type());cv.cvtColor(e,n,cv.COLOR_RGB2YCrCb,0);let l=new cv.Mat(n.rows,n.cols,n.type(),[Math.round(0),Math.round(133),77,0,]),$=new cv.Mat(n.rows,e.cols,n.type(),[235,173,127,255,]),a=new cv.Mat;cv.inRange(n,l,$,a);let o=cv.imread(texElement);cv.resize(o,o,t);let r=new cv.Mat,s=new cv.Mat;cv.bitwise_and(o,o,r,a),cv.bitwise_not(a,a),cv.bitwise_and(e,e,s,a),cv.bitwise_not(a,a);let c=new cv.Mat;cv.add(r,s,c);let i=1,d=1,m=1,_=1,w=0,u=1e3,E=0,h=1e3,g=0;for(;g<500;)0!=a.ucharAt(500,1e3-g*a.channels())&&1===i&&(w=1e3-g,i=0),0!=a.ucharAt(500,g*a.channels())&&1===d&&(u=g,d=0),g+=1;g=0;let b=Math.round((w+u)/2);for(;g<500;)0!=a.ucharAt(1e3-g,b*a.channels())&&1===m&&(E=1e3-g,m=0),0!=a.ucharAt(g,b*a.channels())&&1===_&&(h=g,_=0),g+=1;let y=500,f=500;y=w-60,f=Math.round((h+E)/2)-30;let p=Math.round(Math.abs(w-u)),M=Math.round(Math.abs(h-E)),A=cv.imread(bocaElement),I=cv.imread(bocamaskElement),k=new cv.Size(Math.round(4*p/5*100/100),Math.round(5*M/16*100/100));cv.resize(A,A,k),cv.resize(I,I,k);let B=y+parseInt(50),v=f-parseInt(50);boca_centered=new cv.Mat(1e3,1e3,c.type(),[0,0,0,255]),bocamask_centered=new cv.Mat(1e3,1e3,c.type(),[0,0,0,255]),centerx=Math.round(A.cols/2),centery=Math.round(A.rows/2),g=0;let z=0,C=boca_centered.ucharPtr(0,0);for(;g<A.rows;){for(;z<A.cols;)(C=boca_centered.ucharPtr(g+v-centery,z+B-centerx))[0]=A.ucharAt(g,z*A.channels()),C[1]=A.ucharAt(g,z*A.channels()+1),C[2]=A.ucharAt(g,z*A.channels()+2),C[3]=255,(C=bocamask_centered.ucharPtr(g+v-centery,z+B-centerx))[0]=I.ucharAt(g,z*I.channels()),C[1]=I.ucharAt(g,z*I.channels()+1),C[2]=I.ucharAt(g,z*I.channels()+2),C[3]=255,z+=1;g+=1,z=0}let R=new cv.Mat(boca_centered.rows,boca_centered.cols,boca_centered.type(),[0,32,32,0]),L=new cv.Mat(boca_centered.rows,boca_centered.cols,boca_centered.type(),[255,255,255,255]);bocamasked=new cv.Mat,cv.inRange(bocamask_centered,R,L,bocamasked);let O=new cv.Mat;cv.bitwise_not(bocamasked,bocamasked),cv.bitwise_and(c,c,O,bocamasked),cv.bitwise_not(bocamasked,bocamasked),cv.add(O,boca_centered,c),cv.imshow("finalCanvas",c);let S=document.getElementById("finalCanvas").toDataURL("image/png");document.getElementById("finalImage").src=S,e.delete(),n.delete(),l.delete(),$.delete(),a.delete(),o.delete(),r.delete(),s.delete(),c.delete(),A.delete(),I.delete(),boca_centered.delete(),bocamask_centered.delete(),O.delete(),R.delete(),L.delete(),bocamasked.delete()}function fail(){console.error("algo salio mal")}function onOpenCvReady(){document.getElementById("status").innerHTML=""}inputElement.addEventListener("change",e=>{imgElement.onload=todolisto,imgElement.onerror=fail,imgElement.src=URL.createObjectURL(e.target.files[0])},!1),document.getElementById("ok").addEventListener("click",function(){proceso()});